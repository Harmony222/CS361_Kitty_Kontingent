{% extends "layout.html" %} 
{% block content %}
<!-- CSS FORMATTING -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/find_trails_.css') }}" type="text/css"/>

<!-- JS -->
<script src="{{ url_for('static', filename='js/filter.js') }}"></script>

<!-- Doesn't work... :( -->
<!-- <script src="{{ url_for('static', filename='js/map_view.js') }}" type="text/javascript"></script> -->

<!-- TRAILHEAD MAP API -->
<script
    src="https://maps.googleapis.com/maps/api/js?key={{ map_api_key }}&callback=initMap&libraries=&v=weekly"
    defer>
</script>

<!-- SORT TABLE SCRIPT-->
<script src="http://www.kryogenix.org/code/browser/sorttable/sorttable.js"></script>

<script>
    // MAP UI SCRIPT
    function initMap() {
        const location = { lat: {{ lat }}, lng: {{ lon }} };
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 8,
            center: location,
        });
        setMarkers(map);
    }
    let LOCATIONS = {{ locations | safe }};
    function setMarkers(map) {
        const icons = {
            red: { icon: "http://maps.google.com/mapfiles/kml/paddle/red-circle.png", },
            yellow: { icon: "http://maps.google.com/mapfiles/kml/paddle/ylw-circle.png", },
            green: { icon: "http://maps.google.com/mapfiles/kml/paddle/grn-circle.png", },
        };
        let infoWindow = new google.maps.InfoWindow({ maxWidth: 250 });
        for (let i = 0; i < LOCATIONS.length; i++) {
            let trail = LOCATIONS[i];
            let infoContent = `<h5>${trail[0]}</h5>`
                + `<div><p>${trail[3]}</p></div>`
                + `<div><p><strong>Length:</strong> ${trail[4]} miles</p></div>`
                + `<div><p><strong>Rating:</strong> ${trail[5]} stars</p></div>`
                + `<div><p><strong>Difficulty:</strong> ${trail[6]}</p></div>`
                + `<div><p><strong>${trail[7]}</strong></p></div>`
                + `<a href="${trail[8]}" target="_blank" title="get directions" role="button" class="btn btn-info btn-sm btn-marker">Get Directions</a>`
                + `<a href="${trail[9]}" target="_blank" role="button" class="btn btn-outline-info btn-sm btn-marker">Recommended Gear</a>`;
            let marker = new google.maps.Marker({
                position: { lat: parseFloat(trail[1]), lng: parseFloat(trail[2]) },
                map,
                // icon: icons['red'].icon,
                title: trail[0],
            });
            marker.addListener("click", () => {
                infoWindow.setContent(infoContent);
                infoWindow.open(map, marker);
            });
        }
    }
    // records which tab is active on page load, list or map
    $(function() {
        if ($("#map-view").attr("class").includes("active")) $('#active-tab').val('map');
        else $('#active-tab').val('list');
    });
</script>

<!-- FILTER TRAILS UI -->
<div id="filter-div">
  <button id="filter-button" class="btn btn-lg btn-info" data-placement="right"
        data-html="true" data-popover-content="#filter-popover" data-toggle="popover" onclick="toggleButton()">
        {% if filtered %}
            Clear or Change Filter
        {% else %}
            Filter Trails Just for You
        {% endif %}
  </button>
  <!-- Content for Popover -->
  <div class="hidden" id="filter-popover">
    <div id="popover-title">
      Choose how you want to feel from the hike (click or slide)
    </div>
    <div id="popover-content">
      <div id="popover-slider">
        <form action="/find_trails" method="POST">
          <label id="slider-label" for="slider-range">I want a hike that...</label>
          <input id="filter-slider" name="filter-slider" type="range" class="custom-range" min="1" max="3"
          oninput="$('#filter-slider-in').html(this.value)">
          <label id="filter-slider-in" class="hidden">2</label>
          <ul class="difficulty-list">
            <li>is easy and chill</li>
            <li>matches my fitness level</li>
            <li>challenges me!</li>
          </ul>
          <input type="hidden" name="rad" value={{radius}}>
          <input type="hidden" name="address" value={{address}}>
          <input type="hidden" name="active-tab" value="list" id="active-tab">
          <button name="filter" type="submit" class="btn btn-sm btn-info">Save</button>
          <button name="clear" type="submit" class="btn btn-sm btn-info">Clear Filter</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="card-header text-center">
    <h4>
        Hiking Trails Within {{radius}} Miles of {{address}}
    </h4>
    <div class="map-list-pane">
        <nav>
            <div class="nav nav-tabs nav-justified" id="nav-tab" role="tablist">
            <a class="nav-item nav-link {{ 'active' if view_tab == 'list' }}" id="list-view-tab" data-toggle="tab" href="#list-view" role="tab" aria-controls="list-view" aria-selected="true" onclick="$('#active-tab').val('list')">List View</a>
            <a class="nav-item nav-link {{ 'active' if view_tab == 'map' }}" id="map-view-tab" data-toggle="tab" href="#map-view" role="tab" aria-controls="map-view" aria-selected="false" onclick="$('#active-tab').val('map')">Map View</a>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane show {{ 'active' if view_tab == 'list' }}" id="list-view" role="tabpanel" aria-labelledby="list-view-tab">
                <div class="row">
                    <div class="container">
                        <div class="card bg-light text-dark border-dark">
                            <div>
                                <table class="table table-striped sortable">
                                    <thead>
                                        <tr>
                                            <th scope="col">Trail</th>
                                            <th scope="col">Length(mi)</th>
                                            <th scope="col">Difficulty</th>
                                            <th scope="col">Rating</th>
                                            <th scope="col">Low(ft)</th>
                                            <th scope="col">High(ft)</th>
                                            <th scope="col">Location</th>
                                            <th scope="col">Gear</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in trails_list %}
                                        <tr data-toggle="modal" data-target="#exampleModalCenter">
                                            <td><a href="{{ row[13] }}" target="_blank" title="get directions">{{ row[1] }}</a></td>
                                            <td>{{ row[2] }}</td>
                                            <td>{{ row[3] }}</td>
                                            <td>{{ row[4] }}</td>
                                            <td>{{ row[9] }}</td>
                                            <td>{{ row[8] }}</td>
                                            <td>{{ row[5] }}</td>
                                            <td><a href="{{ row[14] }}" target="_blank">Recommended Gear</a></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane {{ 'active' if view_tab == 'map' }}" id="map-view" role="tabpanel" aria-labelledby="map-view-tab">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
            </div>
            <div class="modal-body">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>